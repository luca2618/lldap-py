services:
      lldap:
        image: lldap/lldap:stable
        ports:
          - 3890:3890
          - 17170:17170
        environment:
          UID: 1000
          GID: 1000
          LLDAP_JWT_SECRET: test-secret-key
          LLDAP_KEY_SEED: test-seed-key
          LLDAP_LDAP_USER_PASS: password
        volumes: []
        healthcheck:
          test: ["CMD", "curl", "-f", "http://localhost:17170"]
          interval: 10s
          timeout: 5s
          retries: 5
      lldap-secure:
        image: lldap/lldap:stable
        ports:
          - 6360:6360
        environment:
          UID: 1000
          GID: 1000
          LLDAP_JWT_SECRET: test-secret-key
          LLDAP_KEY_SEED: test-seed-key
          LLDAP_LDAP_USER_PASS: password
          LLDAP_LDAPS_OPTIONS__ENABLED: "true"
          LLDAP_LDAPS_OPTIONS__CERT_FILE: /etc/ssl/certs/lldap.crt
          LLDAP_LDAPS_OPTIONS__KEY_FILE: /etc/ssl/private/lldap.key
        entrypoint: /bin/sh -c "apk update && apk add --no-cache openssl && mkdir -p /etc/ssl/private && openssl req -x509 -newkey rsa:2048 -keyout /etc/ssl/private/lldap.key -out /etc/ssl/certs/lldap.crt -days 365 -nodes -subj '/CN=localhost' && exec /app/lldap run"
        volumes: []
        healthcheck:
          test: ["CMD", "curl", "-k", "-f", "http://localhost:17170"]
          interval: 10s
          timeout: 5s
          retries: 5
      
      lldap-https-proxy:
        image: nginx:latest
        ports:
          - 443:443
          - 80:80
        depends_on:
          lldap:
            condition: service_healthy
          lldap-secure:
            condition: service_healthy
        volumes:
          - ./nginx.conf:/etc/nginx/nginx.conf:ro
        entrypoint: /bin/sh -c "mkdir -p /tmp && openssl req -x509 -newkey rsa:2048 -keyout /tmp/proxy.key -out /tmp/proxy.crt -days 365 -nodes -subj '/CN=localhost' 2>/dev/null || true && nginx -c /etc/nginx/nginx.conf -g 'daemon off;'"
        healthcheck:
          test: ["CMD", "curl", "-k", "-f", "https://localhost/health"]
          interval: 10s
          timeout: 5s
          retries: 5
